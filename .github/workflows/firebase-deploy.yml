name: Deploy to Firebase Hosting on push to main

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    # Adiciona permissões para que a action possa obter um ID token para autenticar o gcloud/firebase
    permissions:
      contents: read
      id-token: write # Necessário para autenticação workload identity (alternativa futura)

    steps:
      - name: Checkout repository code
        uses: actions/checkout@v4

      # <<< NOVO PASSO: Instalar Firebase Tools e Verificar/Criar Site Hosting >>>
      - name: Setup Firebase CLI and Ensure Hosting Site
        run: |
          # Instala a versão mais recente do Firebase Tools via npm
          npm install -g firebase-tools 
          
          # Tenta listar os sites de hosting. Se falhar (não encontrar), tenta criar.
          echo "Attempting to list hosting sites..."
          firebase hosting:sites:list --project exalted-splicer-456312-e8 --json || \
          (echo "No hosting site found or error listing, attempting to create..." && \
           firebase hosting:sites:create exalted-splicer-456312-e8 --json)
        env:
          # Usa a conta de serviço para autenticar esses comandos CLI
          GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp_sa_key.json 
          # (Vamos criar este arquivo no próximo passo)

      # <<< NOVO PASSO: Criar arquivo temporário com a chave da conta de serviço >>>
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}'
          # Exporta as credenciais para um caminho que o passo seguinte possa usar
          export_credentials_file: '/tmp/gcp_sa_key.json' 

      # <<< PASSO DE DEPLOY ORIGINAL (SEM MUDANÇAS SIGNIFICATIVAS) >>>
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}' # Mantém para a action
          channelId: live
          projectId: exalted-splicer-456312-e8
        # A autenticação agora deve estar mais robusta devido ao passo 'Authenticate to Google Cloud'